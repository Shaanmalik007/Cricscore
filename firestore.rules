rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper: Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper: Check if user is the owner of the document
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // User profiles and history
    match /users/{userId} {
      allow read, write: if isOwner(userId);
      
      match /Teams/{teamId} {
        allow read, write: if isOwner(userId);
      }
      
      match /Matches/{matchId} {
        allow read, write: if isOwner(userId);
      }
    }

    // Global Matches collection
    match /matches/{matchId} {
      // Allow read if match is public OR user is the owner
      allow read: if (resource != null && resource.data.isPublic == true) || 
                   (resource != null && isSignedIn() && resource.data.createdBy == request.auth.uid);
      
      // Allow creation for signed-in users
      allow create: if isSignedIn();
      
      // Allow updates if user is the owner OR if ownership is not yet claimed (legacy support)
      // Also allow public cheer updates for anyone
      allow update: if (resource != null && (resource.data.createdBy == request.auth.uid || !('createdBy' in resource.data))) || 
                    (resource != null && resource.data.isPublic == true && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['cheers']));
      
      allow delete: if resource != null && resource.data.createdBy == request.auth.uid;

      // Balls subcollection
      match /balls/{ballId} {
        // Allow read for anyone if they can read the parent match (public games)
        // For simplicity and performance, we allow read if they have the ID, 
        // as IDs are typically only shared for public games.
        allow read: if true; 
        
        // Allow ball logging if signed in (ownership check is handled by the app logic, 
        // but adding a basic signed-in check here to prevent spam)
        allow create: if isSignedIn();
        allow delete: if isSignedIn();
        allow update: if false; 
      }
    }
  }
}